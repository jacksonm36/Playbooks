---
- name: Update ClamAV and scan system paths
  hosts: docker_hosts
  become: true
  gather_facts: yes

  vars:
    scan_paths:
      - /opt
      - /etc
      - /var/tmp
      - /usr/local/bin
      - /home

  tasks:
    - name: Stop freshclam daemon if running
      service:
        name: clamav-freshclam
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Update virus signature database
      command: freshclam
      register: freshclam_output
      changed_when: "'updated' in freshclam_output.stdout or 'bytecode.cvd' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam output
      debug:
        var: freshclam_output.stdout
      when: freshclam_output is defined

    - name: Scan each path and show results
      block:
        - name: Run ClamAV scan
          command: clamscan -r --max-filesize=100M --max-scansize=200M "{{ item }}"
          register: scan_result
          failed_when: scan_result.rc > 1
          ignore_errors: true

        - name: Show scan result
          debug:
            msg: |
              Scan of {{ item }}:
              Exit Code: {{ scan_result.rc }}
              {% if scan_result.rc == 0 %}Status: CLEAN
              {% elif scan_result.rc == 1 %}Status: INFECTED - THREATS FOUND!
              {% else %}Status: ERROR (code: {{ scan_result.rc }})
              {% endif %}
      loop: "{{ scan_paths }}"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Start freshclam daemon
      service:
        name: clamav-freshclam
        state: started
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]
