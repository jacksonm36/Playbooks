---
- name: Update ClamAV and scan system paths
  hosts: docker_hosts
  become: true
  gather_facts: yes

  vars:
    scan_paths:
      - /opt
      - /etc
      - /var/tmp
      - /usr/local/bin
      - /home
    max_filesize: "100M"
    max_scansize: "200M"

  tasks:
    - name: Verify supported operating system
      fail:
        msg: "Unsupported OS family '{{ ansible_os_family }}'. This playbook supports Debian, RedHat, and Archlinux."
      when: ansible_os_family not in ["Debian", "RedHat", "Archlinux"]

    - name: Install ClamAV package
      package:
        name: clamav
        state: present
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Install ClamAV freshclam service
      package:
        name: "{{ 'clamav-freshclam' if ansible_os_family == 'Debian' else 'clamav' }}"
        state: present
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Stop freshclam daemon if running
      service:
        name: "{{ 'clamav-freshclam' if ansible_os_family in ['Debian', 'Archlinux'] else 'clam-freshclam' }}"
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Update virus signature database
      command: freshclam
      register: freshclam_output
      changed_when: >
        "'updated' in freshclam_output.stdout or 
         'bytecode.cvd' in freshclam_output.stdout or
         'Database updated' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam update status
      debug:
        msg: "FreshClam update completed: {{ freshclam_output.stdout_lines | last }}"
      when: freshclam_output is defined and freshclam_output.stdout_lines | length > 0

    - name: Run ClamAV scan and display results for each path
      block:
        - name: Run ClamAV scan on path
          command: >
            clamscan -r 
            --max-filesize={{ max_filesize }}
            --max-scansize={{ max_scansize }}
            "{{ item }}"
          register: scan_result
          failed_when: scan_result.rc > 1
          ignore_errors: true

        - name: Display scan result
          debug:
            msg: |
              === Scan Result for {{ item }} ===
              Exit Code: {{ scan_result.rc }}
              Status: {% if scan_result.rc == 0 %}CLEAN - No threats found{% elif scan_result.rc == 1 %}INFECTED - Threats detected!{% else %}ERROR - Scan failed (code: {{ scan_result.rc }}){% endif %}
              {% if scan_result.stdout %}
              Summary: {{ (scan_result.stdout_lines | last) | default('No summary available') }}
              {% endif %}
      loop: "{{ scan_paths }}"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]
      loop_control:
        label: "{{ item }}"

    - name: Collect all scan results
      set_fact:
        all_scan_results: "{{ (all_scan_results | default([])) + [scan_result] }}"
      loop: "{{ scan_paths }}"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Generate final scan summary
      debug:
        msg: |
          === FINAL CLAMAV SCAN SUMMARY ===
          Total paths scanned: {{ all_scan_results | length }}
          Clean paths: {{ (all_scan_results | selectattr('rc', 'equalto', 0) | list | length) }}
          Infected paths: {{ (all_scan_results | selectattr('rc', 'equalto', 1) | list | length) }}
          Failed scans: {{ (all_scan_results | selectattr('rc', 'gt', 1) | list | length) }}

    - name: Fail playbook if infections were detected
      fail:
        msg: "VIRUS SCAN ALERT: Infected files detected in {{ (all_scan_results | selectattr('rc', 'equalto', 1) | list | length) }} path(s). Immediate action required!"
      when: 
        - ansible_os_family in ["Debian", "RedHat", "Archlinux"]
        - (all_scan_results | selectattr('rc', 'equalto', 1) | list | length) > 0

    - name: Start freshclam daemon
      service:
        name: "{{ 'clamav-freshclam' if ansible_os_family in ['Debian', 'Archlinux'] else 'clam-freshclam' }}"
        state: started
        enabled: yes
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Final success message
      debug:
        msg: "ClamAV scan completed successfully. All scanned paths are clean."
      when: 
        - ansible_os_family in ["Debian", "RedHat", "Archlinux"]
        - (all_scan_results | selectattr('rc', 'equalto', 1) | list | length) == 0
