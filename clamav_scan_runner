---
- name: Update ClamAV and scan system paths
  hosts: docker_hosts
  become: true
  gather_facts: yes

  vars:
    scan_paths:
      - /opt
      - /etc
      - /var/tmp
      - /usr/local/bin
      - /home

  tasks:
    - name: Stop freshclam daemon if running
      service:
        name: clamav-freshclam
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Update virus signature database
      command: freshclam
      register: freshclam_output
      changed_when: "'updated' in freshclam_output.stdout or 'bytecode.cvd' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam output
      debug:
        var: freshclam_output.stdout
      when: freshclam_output is defined

    - name: Run ClamAV scan on each path
      command: clamscan -r --max-filesize=100M --max-scansize=200M "{{ item }}"
      register: scan_results
      failed_when: scan_results.rc > 1  # Only fail on actual errors, not infections
      loop: "{{ scan_paths }}"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]
      ignore_errors: true

    - name: Display scan results with path names (simple text)
      debug:
        msg: |
          Path: {{ item.item }}
          Result: {% if item.rc == 0 %}CLEAN{% elif item.rc == 1 %}INFECTED{% else %}ERROR{% endif %}
          {{ (item.stdout_lines[-1] if (item.stdout_lines is defined and item.stdout_lines|length > 0) else (item.stdout | trim)) if item.stdout is defined }}
      loop: "{{ scan_results.results }}"

    - name: Generate scan summary
      set_fact:
        clean_count: "{{ (scan_results.results | selectattr('rc', 'equalto', 0) | list | length) }}"
        infected_count: "{{ (scan_results.results | selectattr('rc', 'equalto', 1) | list | length) }}"
        error_count: "{{ (scan_results.results | selectattr('rc', 'gt', 1) | list | length) }}"
        infected_paths: "{{ scan_results.results | selectattr('rc', 'equalto', 1) | map(attribute='item') | list }}"
        failed_paths: "{{ scan_results.results | selectattr('rc', 'gt', 1) | map(attribute='item') | list }}"

    - name: Show infected paths if any were found
      debug:
        msg: |
          WARNING: The following paths were found INFECTED by ClamAV at {{ ansible_date_time.iso8601 }}:
          {% for path in infected_paths %}
            - {{ path }}
          {% endfor %}
      when: infected_count | int > 0

    - name: Show failed scan paths if any
      debug:
        msg: |
          ERROR: The following paths FAILED to scan at {{ ansible_date_time.iso8601 }}:
          {% for path in failed_paths %}
            - {{ path }}
          {% endfor %}
      when: error_count | int > 0

    - name: Show final summary
      debug:
        msg: |
          === FINAL SCAN SUMMARY ===
          Total paths scanned: {{ scan_results.results | length }}
          Clean: {{ clean_count }}
          Infected: {{ infected_count }}
          Failed: {{ error_count }}
          {% if infected_count > 0 %}
          See above for infected paths!
          {% else %}
          SECURITY STATUS: All paths clean
          {% endif %}
          {% if error_count > 0 %}
          See above for failed paths!
          {% endif %}

    - name: Check if clamav-freshclam is systemd-enabled
      command: systemctl is-enabled clamav-freshclam
      register: clamav_freshclam_enabled
      failed_when: false
      changed_when: false
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Enable clamav-freshclam service if not enabled
      systemd:
        name: clamav-freshclam
        enabled: true
      when:
        - ansible_os_family in ["Debian", "RedHat", "Archlinux"]
        - clamav_freshclam_enabled.stdout is defined
        - clamav_freshclam_enabled.stdout != "enabled"

    - name: Start freshclam daemon
      service:
        name: clamav-freshclam
        state: started
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Final success message
      debug:
        msg: "ClamAV scan completed. {{ infected_count }} infected path(s) found, {{ error_count }} failed scan(s). See above for details."
