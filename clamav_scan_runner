---
- name: Update ClamAV and scan system paths
  hosts: docker_hosts
  become: true
  gather_facts: yes

  vars:
    scan_paths:
      - /opt
      - /etc
      - /var/tmp
      - /usr/local/bin
      - /home

  tasks:

    - name: Stop freshclam daemon if running
      service:
        name: clamav-freshclam
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Update virus signature database
      command: freshclam
      register: freshclam_output
      changed_when: "'updated' in freshclam_output.stdout or 'bytecode.cvd' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam output
      debug:
        var: freshclam_output.stdout
      when: freshclam_output is defined

    - name: Run ClamAV scan on each path
      command: clamscan -r {{ scan_path }}
      register: scan_result
      failed_when: scan_result.rc != 0 and scan_result.rc != 1
      loop: "{{ scan_paths }}"
      loop_control:
        loop_var: scan_path
        label: "{{ scan_path }}"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show scan output
      debug:
        msg: |
          Scan completed for {{ scan_path }}.
          {{ scan_result.stdout }}
      loop: "{{ scan_paths }}"
      loop_control:
        loop_var: scan_path
        label: "{{ scan_path }}"
      when: scan_result is defined

    - name: Report if threats were found
      debug:
        msg: "Threats detected in scanned path: {{ scan_path }}"
      when: scan_result.stdout is defined and 'Infected files: 0' not in scan_result.stdout
      loop: "{{ scan_paths }}"
      loop_control:
        loop_var: scan_path
        label: "{{ scan_path }}"

    - name: Report if no threats were found
      debug:
        msg: "No threats found in scanned path: {{ scan_path }}"
      when: scan_result.stdout is defined and 'Infected files: 0' in scan_result.stdout
      loop: "{{ scan_paths }}"
      loop_control:
        loop_var: scan_path
        label: "{{ scan_path }}"

    - name: Report if scan failed
      debug:
        msg: "Scan failed for path: {{ scan_path }}"
      when: scan_result.rc != 0 and scan_result.rc != 1
      loop: "{{ scan_paths }}"
      loop_control:
        loop_var: scan_path
        label: "{{ scan_path }}"
