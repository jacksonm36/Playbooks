---
- name: Update ClamAV and scan system paths with timeout and reporting
  hosts: all
  become: true
  gather_facts: yes

  vars:
    scan_paths:
      - /opt
      - /etc
      - /var/tmp
      - /usr/local/bin
      - /home
    clamscan_timeout: 7200

  tasks:

    - name: Stop freshclam daemon if running
      service:
        name: clamav-freshclam
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Update virus signature database
      command: freshclam
      register: freshclam_output
      changed_when: "'updated' in freshclam_output.stdout or 'bytecode.cvd' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam output
      debug:
        var: freshclam_output.stdout
      when: freshclam_output is defined

    - name: Run ClamAV scan on each path with timeout
      shell: timeout {{ clamscan_timeout }}s clamscan -r "{{ scan_path }}"
      args:
        executable: /bin/bash
      register: clamscan_result
      loop: "{{ scan_paths }}"
      loop_control:
        loop_var: scan_path
      changed_when: false
      failed_when: false
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Combine scan path with result
      set_fact:
        clamav_results: "{{ clamav_results | default([]) + [ {
          'path': item.item,
          'rc': item.rc,
          'timed_out': item.rc == 124,
          'killed': item.rc == 137,
          'infected': item.rc == 1,
          'failed': item.rc > 1 and item.rc not in [124, 137],
          'summary': (
            item.stdout_lines | select('search', 'Infected files:') | list | join('')
            if item.stdout_lines is defined else (item.stdout | default(''))
          )
        } ] }}"
      loop: "{{ clamscan_result.results }}"
      loop_control:
        loop_var: item

    - name: Display scan result per path
      debug:
        msg: |
          [{{ item.path }}] => {% if item.timed_out %}TIMEOUT{% elif item.killed %}KILLED{% elif item.failed %}ERROR{% elif item.infected %}INFECTED{% else %}CLEAN{% endif %}
          {{ item.summary }}
      loop: "{{ clamav_results }}"

    - name: Final summary
      debug:
        msg: |
          === CLAMAV SCAN SUMMARY ===
          Total scanned: {{ clamav_results | length }}
          Clean: {{ clamav_results | rejectattr('infected') | rejectattr('failed') | rejectattr('timed_out') | rejectattr('killed') | list | length }}
          Infected: {{ clamav_results | selectattr('infected') | list | length }}
          Failed: {{ clamav_results | selectattr('failed') | list | length }}
          Timed out: {{ clamav_results | selectattr('timed_out') | list | length }}
          Killed: {{ clamav_results | selectattr('killed') | list | length }}
          {% for r in clamav_results if r.infected %}
          INFECTED: {{ r.path }}
          {% endfor %}
          {% for r in clamav_results if r.failed %}
          ERROR: {{ r.path }}
          {% endfor %}
          {% for r in clamav_results if r.timed_out %}
          TIMEOUT: {{ r.path }}
          {% endfor %}
          {% for r in clamav_results if r.killed %}
          KILLED: {{ r.path }}
          {% endfor %}
          {% if (
            clamav_results | selectattr('infected') | list | length == 0
            and clamav_results | selectattr('failed') | list | length == 0
            and clamav_results | selectattr('timed_out') | list | length == 0
            and clamav_results | selectattr('killed') | list | length == 0
          ) %}
          All paths clean and scanned successfully.
          {% endif %}

    - name: Check if clamav-freshclam is systemd-enabled
      command: systemctl is-enabled clamav-freshclam
      register: clamav_freshclam_enabled
      changed_when: false
      failed_when: false
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Enable clamav-freshclam service if not enabled
      systemd:
        name: clamav-freshclam
        enabled: true
      when:
        - ansible_os_family in ["Debian", "RedHat", "Archlinux"]
        - clamav_freshclam_enabled.stdout is defined
        - clamav_freshclam_enabled.stdout != "enabled"

    - name: Start freshclam daemon
      service:
        name: clamav-freshclam
        state: started
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Always succeed at the end
      debug:
        msg: "Playbook completed. See above for scan results."
      ignore_errors: true
