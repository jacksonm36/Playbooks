---
- name: Deploy and run ClamAV scan bash script
  hosts: all
  become: true
  gather_facts: yes

  vars:
    script_path: /usr/local/bin/clamav-scan.sh
    script_log_dir: /var/log/clamav-scans

  tasks:
    - name: Create script directory
      file:
        path: "{{ script_log_dir }}"
        state: directory
        mode: '0755'

    - name: Find clamav-scan.sh script in repository
      find:
        paths: "{{ playbook_dir }}"
        patterns: "clamav-scan.sh"
        file_type: file
      register: script_file

    - name: Deploy ClamAV scan bash script from repository
      copy:
        src: "{{ script_file.files[0].path | default(playbook_dir + '/clamav-scan.sh') }}"
        dest: "{{ script_path }}"
        mode: '0755'
        remote_src: false
      when: script_file.files | length > 0

    - name: Fail if script file not found
      fail:
        msg: "clamav-scan.sh file not found in repository. Please ensure the script file exists."
      when: script_file.files | length == 0

    - name: Run ClamAV scan script
      shell: "{{ script_path }}"
      register: script_result
      failed_when: false

    - name: Display script output
      debug:
        msg: "{{ script_result.stdout_lines }}"
      when: script_result.stdout_lines is defined

    - name: Display script summary
      debug:
        msg: |
          Script exit code: {{ script_result.rc }}
          {% if script_result.rc == 0 %}
          Status: All scans completed successfully
          {% else %}
          Status: Script encountered issues (check logs at {{ script_log_dir }}/clamscanscript.log)
          {% endif %}
