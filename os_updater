- name: Update and upgrade system
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Fail if OS family is unsupported
      ansible.builtin.fail:
        msg: "Unsupported operating system {{ ansible_facts.os_family }}"
      when: ansible_facts.os_family not in ["Debian", "RedHat", "Suse", "Archlinux"]

    - name: Update & upgrade (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: yes
        upgrade: dist
        autoclean: yes
        autoremove: yes
      when: ansible_facts.os_family == "Debian"

    - name: Ensure packages are latest (Debian/Ubuntu)
      ansible.builtin.apt:
        name: "*"
        state: latest
      when: ansible_facts.os_family == "Debian"

    - name: Update & upgrade (RHEL/CentOS/Fedora/Rocky/Alma)
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: yes
      when:
        - ansible_facts.os_family == "RedHat"
        - "'dnf' in ansible_facts.packages or ansible_facts.distribution_major_version is version('8', '>=')"

    - name: Update & upgrade (legacy RHEL/CentOS with yum)
      ansible.builtin.yum:
        name: "*"
        state: latest
        update_cache: yes
      when:
        - ansible_facts.os_family == "RedHat"
        - "'dnf' not in ansible_facts.packages and ansible_facts.distribution_major_version is version('8', '<')"

    - name: Update & upgrade (SUSE/OpenSUSE)
      community.general.zypper:
        name: "*"
        state: latest
        update_cache: yes
      when: ansible_facts.os_family == "Suse"

    - name: Update & upgrade (Arch/Manjaro)
      community.general.pacman:
        update_cache: yes
        upgrade: yes
      when: ansible_facts.os_family == "Archlinux"

    # Optional: log rotation for package manager logs (adjust paths per OS)
    - name: Install logrotate config for updates (Debian/Ubuntu example)
      ansible.builtin.copy:
        dest: /etc/logrotate.d/system_updates
        content: |
          /var/log/apt/history.log /var/log/apt/term.log {
              weekly
              rotate 4
              compress
              missingok
              notifempty
              create 0640 root root
          }
        owner: root
        group: root
        mode: "0644"
      when: ansible_facts.os_family == "Debian"
