---
- name: Install and update ClamAV virus database on multiple OS types
  hosts: all
  become: true
  gather_facts: yes

  tasks:

    # For RHEL/CentOS 8/9, enable CRB or PowerTools (for dependencies) and EPEL
    - name: Enable CodeReady Builder (CRB) repo on RHEL 9
      ansible.builtin.command: dnf config-manager --set-enabled crb
      register: enable_crb
      changed_when: enable_crb.rc == 0
      failed_when: false
      when:
        - ansible_distribution_major_version is defined
        - ansible_distribution_major_version | int == 9
        - ansible_os_family == "RedHat"

    - name: Enable EPEL repo on RHEL/CentOS/Fedora
      ansible.builtin.yum:
        name: epel-release
        state: present
      when: ansible_os_family == "RedHat"

    - name: Refresh yum/dnf cache after enabling repos (RedHat)
      ansible.builtin.yum:
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: Install ClamAV on Debian/Ubuntu
      ansible.builtin.apt:
        name:
          - clamav
          - clamav-freshclam
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install ClamAV on RHEL/CentOS/Fedora
      ansible.builtin.yum:
        name:
          - clamav
          - clamav-update
        state: present
      register: rhel_clamav
      ignore_errors: true
      when: ansible_os_family == "RedHat"

    - name: Install ClamAV on Arch-based systems
      ansible.builtin.pacman:
        name: clamav
        state: present
        update_cache: yes
      when: ansible_os_family == "Archlinux"

    - name: Stop freshclam daemon (if running)
      ansible.builtin.service:
        name: clamav-freshclam
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Run freshclam to download virus signature database
      ansible.builtin.command: freshclam
      register: freshclam_output
      changed_when: "'bytecode.cvd' in freshclam_output.stdout or 'main.cvd' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam output
      ansible.builtin.debug:
        var: freshclam_output.stdout
      when:
        - freshclam_output is defined
        - ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Install ClamAV on Windows Server (via Chocolatey)
      win_chocolatey:
        name: clamav
        state: present
      when: ansible_os_family == "Windows"

    - name: Run freshclam on Windows to update virus database
      win_command: '"C:\Program Files\ClamAV\freshclam.exe"'
      args:
        chdir: 'C:\Program Files\ClamAV'
      register: win_freshclam
      when: ansible_os_family == "Windows"

    - name: Show Windows freshclam output
      ansible.builtin.debug:
        var: win_freshclam.stdout
      when:
        - ansible_os_family == "Windows"
        - win_freshclam is defined

    - name: Print install note if ClamAV not available on RedHat
      ansible.builtin.debug:
        msg: |
          ClamAV package not found on this RedHat host. 
          On RHEL 9, ensure CRB is enabled: dnf config-manager --set-enabled crb
          On RHEL 8, enable PowerTools: dnf config-manager --set-enabled powertools
          Also ensure EPEL is enabled. See https://docs.fedoraproject.org/en-US/epel/
      when:
        - ansible_os_family == "RedHat"
        - (rhel_clamav is defined and rhel_clamav is failed)
