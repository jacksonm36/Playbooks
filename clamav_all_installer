---
- name: Install and update ClamAV virus database on multiple OS types
  hosts: all
  become: true
  gather_facts: yes

  tasks:

    - name: Ensure EPEL is enabled on RedHat/CentOS/Fedora
      ansible.builtin.yum:
        name: epel-release
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install ClamAV on Debian/Ubuntu
      ansible.builtin.apt:
        name:
          - clamav
          - clamav-freshclam
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install ClamAV on RHEL/CentOS/Fedora
      ansible.builtin.yum:
        name:
          - clamav
          - clamav-update
        state: present
      ignore_errors: true
      when: ansible_os_family == "RedHat"

    - name: Install ClamAV on Arch-based systems
      ansible.builtin.pacman:
        name: clamav
        state: present
        update_cache: yes
      when: ansible_os_family == "Archlinux"

    - name: Stop freshclam daemon (if running)
      ansible.builtin.service:
        name: clamav-freshclam
        state: stopped
      ignore_errors: true
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Run freshclam to download virus signature database
      ansible.builtin.command: freshclam
      register: freshclam_output
      changed_when: "'bytecode.cvd' in freshclam_output.stdout or 'main.cvd' in freshclam_output.stdout"
      when: ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Show freshclam output
      ansible.builtin.debug:
        var: freshclam_output.stdout
      when:
        - freshclam_output is defined
        - ansible_os_family in ["Debian", "RedHat", "Archlinux"]

    - name: Install ClamAV on Windows Server (via Chocolatey)
      win_chocolatey:
        name: clamav
        state: present
      when: ansible_os_family == "Windows"

    - name: Run freshclam on Windows to update virus database
      win_command: '"C:\Program Files\ClamAV\freshclam.exe"'
      args:
        chdir: 'C:\Program Files\ClamAV'
      register: win_freshclam
      when: ansible_os_family == "Windows"

    - name: Show Windows freshclam output
      ansible.builtin.debug:
        var: win_freshclam.stdout
      when:
        - ansible_os_family == "Windows"
        - win_freshclam is defined

    - name: Print install note if ClamAV not available on RedHat
      ansible.builtin.debug:
        msg: "ClamAV package not found on this RedHat host. Please ensure EPEL is enabled and metadata is up-to-date."
      when:
        - ansible_os_family == "RedHat"
        - (ansible_facts.packages is not defined or 'clamav' not in ansible_facts.packages)
